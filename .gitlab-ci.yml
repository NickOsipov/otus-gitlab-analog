include:
  - local: ssh-setup.yml

stages:
  - build
  - test
  - deploy

variables:
  DEPLOY_PATH: "/home/ubuntu/fastapi-app"

build-job:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apt-get update && apt-get install make -y
  script:
    - env > .env
    - make build
    - make push

test-job:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apt-get update && apt-get install make -y
  script:
    - make test-in-docker

deploy-job:
  stage: deploy
  image: python:3.11.4-slim-bookworm
  extends:
    - .ssh-setup
  script:
    - env > .env
    - make deploy
