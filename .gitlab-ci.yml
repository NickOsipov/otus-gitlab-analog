include:
  - local: ssh-setup.yml

stages:
  - build
  - test
  - deploy

variables:
  DEPLOY_PATH: "/home/ubuntu/fastapi-app"
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  FF_NETWORK_PER_BUILD: "true"

build-job:
  stage: build
  image: docker:27-cli
  services:
    - name: docker:27-dind
      command: ["--tls=false"]
  before_script:
    - apk add make bash
    - until docker info; do sleep 1; done
  script:
    - bash scripts/create-dotenv.sh
    - make build
    - make push

test-job:
  stage: test
  image: docker:27-cli
  services:
    - name: docker:27-dind
      command: ["--tls=false"]
  before_script:
    - apk add make bash
    - until docker info; do sleep 1; done
  script:
    - bash scripts/create-dotenv.sh
    - make test-in-docker

deploy-job:
  stage: deploy
  image: ubuntu:20.04
  extends:
    - .ssh-setup
  script:
    - bash scripts/create-dotenv.sh
    - make deploy
