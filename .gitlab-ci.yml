include:
  - local: ssh-setup.yml

stages:
  - build
  - test
  - deploy

variables:
  DEPLOY_PATH: "/home/ubuntu/fastapi-app"

build-job:
  stage: build
  image: docker:28-cli
  services:
    - docker:28-dind
  before_script:
    - apk add make
  script:
    - env > .env
    - make build
    - make push

test-job:
  stage: test
  image: docker:28-cli
  services:
    - docker:28-dind
  before_script:
    - apk add make
  script:
    - env > .env
    - make test-in-docker

deploy-job:
  stage: deploy
  image: ubuntu:20.04
  extends:
    - .ssh-setup
  script:
    - env > .env
    - make deploy
