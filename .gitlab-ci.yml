include:
  - local: ssh-setup.yml

stages:
  - build
  - test
  - deploy

variables:
  DEPLOY_PATH: "/home/ubuntu/fastapi-app"
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

build-job:
  stage: build
  image: docker:28-cli
  services:
    - docker:28-dind
  before_script:
    - apk add make bash
  script:
    - bash scripts/create-dotenv.sh
    - make build
    - make push

test-job:
  stage: test
  image: docker:28-cli
  services:
    - docker:28-dind
  before_script:
    - apk add make bash
  script:
    - bash scripts/create-dotenv.sh
    - make test-in-docker

deploy-job:
  stage: deploy
  image: ubuntu:20.04
  extends:
    - .ssh-setup
  script:
    - bash scripts/create-dotenv.sh
    - make deploy
